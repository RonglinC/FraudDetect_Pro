{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow-lg" style="border-radius: 12px;">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">ğŸ’¬ FraudDetectorPro Chatbot</h3>
    </div>
    <div class="card-body d-flex flex-column" style="height: 500px;">
      <div id="chatbot-messages" class="flex-grow-1 mb-3 p-3 border rounded overflow-auto bg-light" style="border-radius: 10px;">
        <p class="text-muted text-center mt-3">Start a conversation with the AI assistant.</p>
      </div>
      <div class="input-group">
        <input 
          type="text" 
          id="chatbot-message" 
          class="form-control" 
          placeholder="Type your message..." 
          autocomplete="off"
        >
        <button id="chatbot-send" class="btn btn-primary">Send</button>
      </div>
      <div class="text-center mt-3">
        <a href="{{ url_for('homepage') }}" class="btn btn-outline-secondary btn-sm">â† Back to Home</a>
      </div>
    </div>
  </div>
</div>

<script>
const chatbotMessages = document.getElementById("chatbot-messages");
const chatbotMessageInput = document.getElementById("chatbot-message");
const chatbotSendButton = document.getElementById("chatbot-send");

function addMessage(content, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("my-2", "p-2", "rounded", "w-75");
  messageDiv.style.wordWrap = "break-word";
  
  if (sender === "user") {
    messageDiv.classList.add("bg-primary", "text-white", "ms-auto");
    messageDiv.textContent = `You: ${content}`;
  } else {
    messageDiv.classList.add("bg-light", "text-dark", "me-auto", "border");
    messageDiv.textContent = `Bot: ${content}`;
  }

  chatbotMessages.appendChild(messageDiv);
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

async function sendMessage() {
  const message = chatbotMessageInput.value.trim();
  if (!message) return;

  addMessage(message, "user");
  chatbotMessageInput.value = "";

  // Loading message
  const loadingMsg = document.createElement("div");
  loadingMsg.classList.add("text-muted", "fst-italic", "mt-2");
  loadingMsg.textContent = "Bot is typing...";
  chatbotMessages.appendChild(loadingMsg);
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

  try {
    const response = await fetch("/chatbot_api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });

    const data = await response.json();
    chatbotMessages.removeChild(loadingMsg);

    addMessage(data.response || data.error || "No response from the server.", "bot");
  } catch (error) {
    chatbotMessages.removeChild(loadingMsg);
    addMessage("Error connecting to backend.", "bot");
  }
}

chatbotSendButton.addEventListener("click", sendMessage);
chatbotMessageInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});
</script>
{% endblock %}
